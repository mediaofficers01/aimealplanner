<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meal & Festival Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha512/0.8.0/sha512.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff; /* Fallback */
            background-image: linear-gradient(135deg, #f5f3ff 0%, #dee2ff 100%);
        }
        .plan-output-content {
            white-space: pre-wrap;
        }
        .plan-output-content h4 { font-size: 1.125rem; font-weight: 700; margin-top: 0.75rem; margin-bottom: 0.25rem; }
        .plan-output-content strong { font-weight: 600; }
        .plan-output-content ul { list-style-type: disc; padding-left: 1.5rem; }
        .plan-output-content li { margin-bottom: 0.25rem; }
        .plan-output-content hr { margin-top: 1rem; margin-bottom: 1rem; border-color: #d1d5db; }
        .plan-output-content a { color: #4f46e5; text-decoration: underline; }


        #close-login-modal {
            font-size: 2rem;
            line-height: 1;
        }
        .tab-btn.active {
            background-color: #7c3aed;
            color: white;
        }
        .tab-btn {
            background-color: #f5f3ff;
            color: #5b21b6;
        }
        .premium-card {
             background: rgba(255, 255, 255, 0.6);
             border: 1px solid rgba(255, 255, 255, 0.2);
             box-shadow: 0 8px 32px 0 rgba(124, 58, 237, 0.1);
             backdrop-filter: blur(4px);
             -webkit-backdrop-filter: blur(4px);
        }
        .generate-btn {
            background-image: linear-gradient(to right, #8b5cf6, #ec4899);
        }
        /* Spinner Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7c3aed;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* History Styles */
        #history-list .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #history-list .history-item:hover {
            background-color: #f9fafb;
        }
        #history-list .history-item.active {
            background-color: #ede9fe;
            border-right-width: 0;
        }
        @media (min-width: 768px) {
            #history-list .history-item.active {
                 border-right-width: 3px;
                 border-color: #7c3aed;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="flex justify-between items-center">
                <div></div> <!-- Spacer -->
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">AI Meal & Festival Planner</h1>
                <div id="auth-header-container">
                    <button id="header-login-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Login</button>
                    <div id="user-status-container" class="hidden text-right">
                         <p id="user-status" class="text-sm text-gray-600"></p>
                         <button id="logout-btn" class="text-xs text-indigo-600 font-semibold">Logout</button>
                    </div>
                </div>
            </div>
            <p class="text-lg text-gray-600 mt-2">Your all-in-one assistant for Indian families.</p>
        </div>

        <!-- Main Content Area -->
        <div class="bg-white/70 backdrop-blur-xl border border-gray-200 rounded-2xl shadow-lg p-4 sm:p-6">
            <!-- Tab Navigation -->
            <div class="flex flex-wrap justify-center bg-purple-100/50 rounded-xl p-1.5 gap-2">
                <button id="meal-planner-tab-btn" class="tab-btn active flex-grow py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 3.3a2.1 2.1 0 0 1 3 3L12 16l-4 1 1-4Z"/></svg>
                    <span>Meal Planner</span>
                </button>
                <button id="festival-assistant-tab-btn" class="tab-btn flex-grow py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z"/><path d="M12 20.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z"/><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M16.5 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M5.5 18.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M16.5 18.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M3 12a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 3 12Z"/><path d="M20 12a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="m15.5 8.5-1 1-4-4 1-1a2.12 2.12 0 0 1 3 0l1 1a2.12 2.12 0 0 1 0 3Z"/><path d="M8.5 15.5l1-1 4 4-1 1a2.12 2.12 0 0 1-3 0l-1-1a2.12 2.12 0 0 1 0-3Z"/></svg>
                    <span>Festival Assistant</span>
                </button>
                <button id="quick-mode-tab-btn" class="tab-btn flex-grow py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.6 3.2-5.7 6c-2.3 2.4-2.3 6.1 0 8.5l5.7 6"/><path d="M5.4 3.2h.1c3.3 0 6 2.7 6 6s-2.7 6-6 6h-.1"/></svg>
                    <span>Quick Mode</span>
                </button>
                 <button id="history-tab-btn" class="tab-btn flex-grow py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M12 8v4l2 2"/></svg>
                    <span>History</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-6 min-h-[220px]">
                <!-- Meal Planner Content -->
                <div id="meal-planner-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="family-size" type="number" placeholder="Family Size (e.g., 4)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="4" required min="1">
                        <input id="plan-days" type="number" placeholder="Number of Days (e.g., 7)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" value="7" min="1" max="14">
                        <select id="diet-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option>Veg</option> <option>Non-Veg</option>
                        </select>
                         <select id="allergies" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option>None (Allergies)</option> <option>Nut Allergy</option> <option>Lactose Intolerance</option> <option>Gluten-Free</option>
                        </select>
                        <select id="cuisine-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 md:col-span-2">
                            <option>North Indian (Punjabi)</option> <option>South Indian</option> <option>Gujarati</option> <option>Bengali</option>
                        </select>
                        <select id="language" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 md:col-span-2">
                            <option>English</option> <option>Hinglish</option>
                        </select>
                    </div>
                    <button id="generate-plan-btn" class="generate-btn mt-6 w-full text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300 flex items-center justify-center space-x-2">
                        <span class="btn-text">Generate Weekly Meal Plan</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>

                <!-- Festival Assistant Content -->
                <div id="festival-assistant-content" class="hidden">
                    <div class="text-center">
                         <h3 class="text-2xl font-bold text-gray-800 mb-4">Plan for a Festival</h3>
                         <select id="festival-select" class="w-full max-w-sm mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                             <option>Diwali</option> <option>Holi</option> <option>Eid</option> <option>Navratri</option> <option>Ganesh Chaturthi</option> <option>Pongal</option>
                         </select>
                         <button id="generate-festival-btn" class="generate-btn mt-4 w-full max-w-sm mx-auto text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300 flex items-center justify-center space-x-2">
                            <span class="btn-text">Get Festival Guide</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Quick Mode Content -->
                <div id="quick-mode-content" class="hidden text-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Get a Quick Meal Idea</h3>
                    <p class="text-gray-600 mb-4">Instantly generate a random meal plan for today.</p>
                    <button id="generate-quick-btn" class="generate-btn mt-4 w-full max-w-sm mx-auto text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300 flex items-center justify-center space-x-2">
                        <span class="btn-text">Generate Quick Plan</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
                
                <!-- History Content -->
                <div id="history-content" class="hidden flex flex-col md:flex-row min-h-[450px] border rounded-lg bg-white overflow-hidden">
                    <div id="history-list" class="w-full md:w-1/3 border-b md:border-b-0 md:border-r overflow-y-auto max-h-48 md:max-h-full">
                        <!-- History list items will be injected here -->
                    </div>
                    <div id="history-display" class="w-full md:w-2/3 p-4 overflow-y-auto">
                        <p class="text-center text-gray-500">Select a plan from the list to view it.</p>
                    </div>
                </div>
            </div>
             <p id="usage-count-info" class="text-xs text-center text-gray-500 mt-4">Log in to track your uses.</p>

            <!-- Output Area -->
             <div id="plan-output-container" class="mt-6 hidden">
                <div id="plan-output" class="plan-output"></div>
             </div>

            <!-- Footer / Premium Packs -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Premium One-Time Packs</h3>
                </div>
                <div id="premium-packs-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <!-- Unlock More Uses Card - Initially Hidden -->
                    <div id="unlock-uses-card" class="premium-card text-center p-6 rounded-2xl hidden md:col-span-2">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-100 mb-4">
                            <span class="text-3xl">✨</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">Unlock More Uses</h4>
                        <p class="text-gray-600 text-sm my-2">You've used all your free plans. Get 100 more to continue!</p>
                        <button class="buy-premium-btn mt-4 w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-300" data-amount="10.00" data-product="Unlock 100 More Uses">Buy 100 More Uses for ₹10</button>
                    </div>
                    <!-- Kids' Tiffin Box Planner -->
                    <div class="premium-card text-center p-6 rounded-2xl" data-product-card="Kids Tiffin Box AI Planner">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-pink-100 mb-4">
                            <span class="text-3xl">😊</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">Kids' Tiffin Box AI Planner</h4>
                        <p class="text-gray-600 text-sm my-2">Endless, healthy, and fun ideas for your child's tiffin box.</p>
                        <div class="mt-4">
                            <button class="buy-premium-btn w-full bg-pink-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-600 transition duration-300" data-amount="99.00" data-product="Kids Tiffin Box AI Planner">Buy Now for ₹99</button>
                            <button class="generate-premium-plan-btn hidden w-full generate-btn text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2" data-product-prompt="a week of healthy and fun tiffin box ideas for a child">
                                <span class="btn-text">Generate Tiffin Plan</span>
                                <div class="loader hidden"></div>
                            </button>
                            <p class="expiry-date-info text-xs text-green-700 font-semibold mt-2 hidden"></p>
                        </div>
                    </div>
                    <!-- Navratri Special Diet Plan -->
                    <div class="premium-card text-center p-6 rounded-2xl" data-product-card="Navratri Special Diet Plan">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 mb-4">
                            <span class="text-3xl">🔥</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">Navratri Special Diet Plan</h4>
                        <p class="text-gray-600 text-sm my-2">Complete 9-day Satvik meal plan for Navratri fasting.</p>
                        <div class="mt-4">
                            <button class="buy-premium-btn w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-300" data-amount="49.00" data-product="Navratri Special Diet Plan">Buy Now for ₹49</button>
                             <button class="generate-premium-plan-btn hidden w-full generate-btn text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2" data-product-prompt="a complete 9-day Satvik meal plan for Navratri fasting">
                                <span class="btn-text">Generate Navratri Plan</span>
                                <div class="loader hidden"></div>
                            </button>
                             <p class="expiry-date-info text-xs text-green-700 font-semibold mt-2 hidden"></p>
                        </div>
                    </div>
                </div>
            </div>
            
             <p id="payment-status" class="text-sm text-center text-red-500 h-4 mt-4"></p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div id="login-modal" class="relative bg-white rounded-2xl shadow-lg p-8 w-full max-w-md">
            <button id="close-login-modal" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800">&times;</button>
            <div id="login-container">
                <!-- Login form will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Hidden form for PayUmoney -->
    <form id="payment-form" method="post" class="hidden"></form>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, Timestamp, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUoU9RFUJi56rYHERq8zOrl1qQBB5KQSM",
            authDomain: "mymealplannerapp-615f7.firebaseapp.com",
            projectId: "mymealplannerapp-615f7",
            storageBucket: "mymealplannerapp-615f7.firebasestorage.app",
            messagingSenderId: "653426216828",
            appId: "1:653426216828:web:a54158b674dfd72cf71ef9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'us-central1'); 

        // --- UI Elements ---
        const logoutBtn = document.getElementById('logout-btn');
        const headerLoginBtn = document.getElementById('header-login-btn');
        const userStatusContainer = document.getElementById('user-status-container');
        const userStatus = document.getElementById('user-status');
        const paymentStatus = document.getElementById('payment-status');
        const usageCountInfo = document.getElementById('usage-count-info');
        const planOutputContainer = document.getElementById('plan-output-container');
        const planOutput = document.getElementById('plan-output');
        const loginModalOverlay = document.getElementById('login-modal-overlay');
        const closeLoginModalBtn = document.getElementById('close-login-modal');
        const loginContainer = document.getElementById('login-container');
        const unlockUsesCard = document.getElementById('unlock-uses-card');
        const historyContainer = document.getElementById('history-container');
        const historyList = document.getElementById('history-list');
        const historyDisplay = document.getElementById('history-display');
        
        // Action Buttons
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const generateFestivalBtn = document.getElementById('generate-festival-btn');
        const generateQuickBtn = document.getElementById('generate-quick-btn');
        const allGenerateBtns = [generatePlanBtn, generateFestivalBtn, generateQuickBtn];
        
        // Tab elements
        const mealPlannerTabBtn = document.getElementById('meal-planner-tab-btn');
        const festivalAssistantTabBtn = document.getElementById('festival-assistant-tab-btn');
        const quickModeTabBtn = document.getElementById('quick-mode-tab-btn');
        const historyTabBtn = document.getElementById('history-tab-btn');
        const mealPlannerContent = document.getElementById('meal-planner-content');
        const festivalAssistantContent = document.getElementById('festival-assistant-content');
        const quickModeContent = document.getElementById('quick-mode-content');
        const historyContent = document.getElementById('history-content');
        const tabs = [mealPlannerTabBtn, festivalAssistantTabBtn, quickModeTabBtn, historyTabBtn];
        const contents = [mealPlannerContent, festivalAssistantContent, quickModeContent, historyContent];

        let confirmationResult = null;
        let usageCount = 0;
        let userPurchases = {};
        const INITIAL_FREE_USES = 4;

        // --- Firestore Logic ---
        async function getUserData(userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                usageCount = data.usageCount || 0;
                userPurchases = data.purchases || {};
            } else {
                await setDoc(userDocRef, { usageCount: 0, purchases: {} });
                usageCount = 0;
                userPurchases = {};
            }
            updateUIForUsage();
            updateUIForPurchases();
        }

        async function updateUserUsageCount(userId) {
            usageCount++;
            const userDocRef = doc(db, "users", userId);
            await setDoc(userDocRef, { usageCount: usageCount }, { merge: true });
            updateUIForUsage();
        }

        async function savePlanToHistory(userId, prompt, plan) {
            if (!userId) return;
            const historyColRef = collection(db, "users", userId, "savedPlans");
            await addDoc(historyColRef, {
                prompt: prompt,
                plan: plan,
                createdAt: Timestamp.now()
            });
        }

        async function loadHistory(userId) {
            if (!userId) return;
            historyList.innerHTML = '<p class="p-3 text-center text-gray-500">Loading...</p>';
            historyDisplay.innerHTML = '<p class="text-center text-gray-500 p-4">Select a plan from the list to view it.</p>';
            
            const historyColRef = collection(db, "users", userId, "savedPlans");
            const q = query(historyColRef, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                historyList.innerHTML = '<p class="p-3 text-center text-gray-500">No saved plans.</p>';
                return;
            }

            historyList.innerHTML = '';
            const historyItems = [];
            querySnapshot.forEach((doc) => {
                historyItems.push({ id: doc.id, ...doc.data() });
            });

            historyItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'history-item';
                itemEl.innerHTML = `
                    <p class="font-semibold text-sm truncate">${item.prompt}</p>
                    <p class="text-xs text-gray-500">${item.createdAt.toDate().toLocaleString()}</p>
                `;
                itemEl.addEventListener('click', () => {
                    historyList.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
                    itemEl.classList.add('active');
                    historyDisplay.innerHTML = `
                        <div class="flex flex-wrap justify-between items-center gap-2 mb-2">
                            <h4 class="font-bold text-lg">${item.prompt}</h4>
                            <div class="share-buttons flex space-x-2">
                                <button class="share-whatsapp-btn bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600 text-sm flex items-center space-x-1.5" data-plan-text="${encodeURIComponent(item.plan)}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a10 10 0 1 0-20 0 10 10 0 0 0 10 10z"/><path d="m10 10-2 2 2 2"/><path d="m14 14 2-2-2-2"/></svg>
                                    <span>WhatsApp</span>
                                </button>
                                <button class="share-email-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 text-sm flex items-center space-x-1.5" data-plan-text="${encodeURIComponent(item.plan)}" data-prompt="${encodeURIComponent(item.prompt)}">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                                    <span>Email</span>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm plan-output-content">${simpleMarkdownToHtml(item.plan)}</div>
                    `;
                });
                historyList.appendChild(itemEl);
                if (index === 0) {
                    itemEl.click();
                }
            });
        }
        
        function updateUIForUsage() {
            const usesLeft = Math.max(0, INITIAL_FREE_USES - usageCount);
            usageCountInfo.textContent = `You have ${usesLeft} ${usesLeft === 1 ? 'use' : 'uses'} remaining.`;

            if (usesLeft <= 0) {
                unlockUsesCard.classList.remove('hidden');
                allGenerateBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.querySelector('.btn-text').textContent = "Out of Uses";
                    btn.classList.remove('generate-btn');
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                });
            } else {
                unlockUsesCard.classList.add('hidden');
                 allGenerateBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.add('generate-btn');
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                });
                generatePlanBtn.querySelector('.btn-text').textContent = "Generate Weekly Meal Plan";
                generateFestivalBtn.querySelector('.btn-text').textContent = "Get Festival Guide";
                generateQuickBtn.querySelector('.btn-text').textContent = "Generate Quick Plan";
            }
        }

        function updateUIForPurchases() {
            document.querySelectorAll('[data-product-card]').forEach(card => {
                const product = card.dataset.productCard;
                const buyButton = card.querySelector('.buy-premium-btn');
                const generateButton = card.querySelector('.generate-premium-plan-btn');
                const expiryInfo = card.querySelector('.expiry-date-info');

                const purchaseData = userPurchases[product];

                buyButton.classList.remove('hidden');
                generateButton.classList.add('hidden');
                expiryInfo.classList.add('hidden');

                if (purchaseData && typeof purchaseData === 'object' && purchaseData.purchaseDate) {
                    const purchaseDate = purchaseData.purchaseDate.toDate();
                    const expiryDate = new Date(purchaseDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    
                    if (new Date() < expiryDate) { 
                        buyButton.classList.add('hidden');
                        generateButton.classList.remove('hidden');
                        expiryInfo.textContent = `Expires on: ${expiryDate.toLocaleDateString()}`;
                        expiryInfo.classList.remove('hidden');
                    }
                }
            });
        }
        
        // --- Authentication Logic ---
        function setupRecaptcha() {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible', 'callback': () => {} });
        }

        async function sendOtp() {
            const phoneNumber = loginContainer.querySelector('#phone-number').value;
            if (!/^\+[1-9]\d{1,14}$/.test(phoneNumber)) {
                loginContainer.querySelector('#auth-status').textContent = 'Please enter a valid phone number with country code.'; return;
            }
            loginContainer.querySelector('#auth-status').textContent = 'Sending OTP...'; 
            loginContainer.querySelector('#send-otp-btn').disabled = true;
            try {
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
                loginContainer.querySelector('#auth-status').textContent = 'OTP sent successfully!';
                loginContainer.querySelector('#otp-section').classList.remove('hidden'); 
                loginContainer.querySelector('#send-otp-btn').textContent = 'Resend OTP';
            } catch (error) {
                loginContainer.querySelector('#auth-status').textContent = `Error: ${error.message}`;
                window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
            } finally { 
                loginContainer.querySelector('#send-otp-btn').disabled = false; 
            }
        }

        async function verifyOtp() {
            const code = loginContainer.querySelector('#otp').value;
            if (!code || code.length !== 6) { loginContainer.querySelector('#auth-status').textContent = 'Please enter a valid 6-digit OTP.'; return; }
            loginContainer.querySelector('#auth-status').textContent = 'Verifying...';
            loginContainer.querySelector('#verify-otp-btn').disabled = true;
            try {
                await confirmationResult.confirm(code);
                loginContainer.innerHTML = `<div class="text-center p-8"><svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h2 class="mt-4 text-2xl font-bold text-gray-800">Login Successful!</h2></div>`;
                setTimeout(() => {
                    loginModalOverlay.classList.add('hidden');
                    resetLoginForm();
                }, 2000);
            } catch (error) {
                loginContainer.querySelector('#auth-status').textContent = `Error: Invalid OTP or session expired.`;
            } finally { 
                const verifyBtn = loginContainer.querySelector('#verify-otp-btn');
                if(verifyBtn) verifyBtn.disabled = false; 
            }
        }

        function resetLoginForm() {
             loginContainer.innerHTML = `
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-gray-800">Login Required</h1>
                    <p class="text-gray-500">Please verify your phone number to continue.</p>
                </div>
                <div class="space-y-4 mt-6">
                    <div>
                        <label for="phone-number" class="text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phone-number" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="+91 XXXXX XXXXX">
                    </div>
                    <button id="send-otp-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Send OTP</button>
                    <div id="recaptcha-container"></div>
                    <div id="otp-section" class="hidden space-y-2">
                        <label for="otp" class="text-sm font-medium text-gray-700">Enter OTP</label>
                        <input type="text" id="otp" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="6-digit code">
                        <button id="verify-otp-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Verify OTP</button>
                    </div>
                    <p id="auth-status" class="text-sm text-center text-red-500 h-4"></p>
                </div>
            `;
            loginContainer.querySelector('#send-otp-btn').addEventListener('click', sendOtp);
            loginContainer.querySelector('#verify-otp-btn').addEventListener('click', verifyOtp);
        }
        
        // --- PayUmoney Integration ---
        function handlePayment(amount, productInfo) {
            if (!auth.currentUser) { loginModalOverlay.classList.remove('hidden'); return; }
            
            const payUDetails = { key: "8z5rZQDi", paymentUrl: "https://secure.payu.in/_payment" };
            const currentUser = auth.currentUser;
            const salt = "IsygW4nDGh";
            const functionUrl = "https://us-central1-mymealplannerapp-615f7.cloudfunctions.net/paymentResponse";

            const transactionData = {
                txnid: `AI-MEAL-${productInfo.replace(/\s+/g, '')}-${Date.now()}`,
                amount: amount, productinfo: productInfo, firstname: 'AI User', email: 'test@example.com',
                phone: currentUser.phoneNumber.substring(3),
                surl: functionUrl, furl: functionUrl,
                udf1: currentUser.uid, udf2: '', udf3: '', udf4: '', udf5: '',
            };

            const hashString = `${payUDetails.key}|${transactionData.txnid}|${transactionData.amount}|${transactionData.productinfo}|${transactionData.firstname}|${transactionData.email}|${transactionData.udf1}|${transactionData.udf2}|${transactionData.udf3}|${transactionData.udf4}|${transactionData.udf5}||||||${salt}`;
            const formData = { ...transactionData, key: payUDetails.key, hash: sha512(hashString) };
            
            const form = document.getElementById('payment-form');
            form.action = payUDetails.paymentUrl; form.innerHTML = '';
            for (const key in formData) {
                const input = document.createElement('input');
                input.type = 'hidden'; input.name = key; input.value = formData[key];
                form.appendChild(input);
            }
            form.submit();
        }

        // --- AI Logic (Client-side) ---
        async function generatePlan(prompt, isPremium = false, callingButton) {
            if (!auth.currentUser) {
                loginModalOverlay.classList.remove('hidden');
                return;
            }

            if (!isPremium) {
                const usesLeft = Math.max(0, INITIAL_FREE_USES - usageCount);
                if (usesLeft <= 0) {
                    paymentStatus.textContent = "You have used all free plans. Please purchase more.";
                    setTimeout(() => paymentStatus.textContent = '', 5000);
                    return;
                }
            }
            
            contents.forEach(content => content.classList.add('hidden'));
            planOutputContainer.classList.remove('hidden');
            
            const buttonText = callingButton.querySelector('.btn-text');
            const loader = callingButton.querySelector('.loader');
            const originalButtonText = buttonText.textContent;

            buttonText.textContent = 'Generating...';
            loader.classList.remove('hidden');
            callingButton.disabled = true;
            planOutput.innerHTML = '<div class="flex justify-center items-center h-24"><div class="loader"></div></div>';

            try {
                const generatePlanAICallable = httpsCallable(functions, 'generatePlanAI');
                const result = await generatePlanAICallable({ prompt: prompt });
                
                const generatedText = result.data.plan;
                planOutput.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center gap-2 mb-2">
                        <h4 class="font-semibold text-lg text-gray-700">Your AI Generated Plan:</h4>
                        <div class="share-buttons flex space-x-2">
                           <button class="share-whatsapp-btn bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600 text-sm flex items-center space-x-1.5" data-plan-text="${encodeURIComponent(generatedText)}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a10 10 0 1 0-20 0 10 10 0 0 0 10 10z"/><path d="m10 10-2 2 2 2"/><path d="m14 14 2-2-2-2"/></svg>
                                <span>WhatsApp</span>
                            </button>
                            <button class="share-email-btn bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 text-sm flex items-center space-x-1.5" data-plan-text="${encodeURIComponent(generatedText)}" data-prompt="${encodeURIComponent(prompt)}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                                <span>Email</span>
                            </button>
                             <button class="copy-plan-btn bg-gray-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-gray-600 text-sm flex items-center space-x-1.5" data-plan-text="${encodeURIComponent(generatedText)}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                <span>Copy</span>
                            </button>
                        </div>
                    </div>
                    <div class="plan-output-content">${simpleMarkdownToHtml(generatedText)}</div>
                `;
                
                await savePlanToHistory(auth.currentUser.uid, prompt, generatedText);

                if (!isPremium) {
                    updateUserUsageCount(auth.currentUser.uid);
                }
            } catch (error) {
                console.error("Cloud Function call failed with error:", error);
                let errorMessage = 'An error occurred while generating your plan. Please try again.';
                if (error.code && error.message) {
                    errorMessage = `Error: ${error.message}`;
                }
                planOutput.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
            } finally {
                buttonText.textContent = originalButtonText;
                loader.classList.add('hidden');
                callingButton.disabled = false;
            }
        }

        function simpleMarkdownToHtml(text) {
            let html = text
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-indigo-600 hover:underline">$1</a>')
                .replace(/^### (.*?$)/gim, '<h4 class="font-bold mt-3 mb-1">$1</h4>')
                .replace(/^## (.*?$)/gim, '<h3 class="font-bold text-lg mt-4 mb-2">$1</h3>')
                .replace(/^# (.*?$)/gim, '<h2 class="font-bold text-xl mt-4 mb-2">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/---/g, '<hr class="my-4 border-gray-300">');
            
            const lines = html.split('\n');
            let inList = false;
            html = lines.map(line => {
                if (line.trim().startsWith('* ') || line.trim().startsWith('- ')) {
                    const lineContent = line.trim().substring(2);
                    if (!inList) {
                        inList = true;
                        return '<ul><li>' + lineContent + '</li>';
                    }
                    return '<li>' + lineContent + '</li>';
                }
                if (inList) {
                    inList = false;
                    return '</ul>' + line;
                }
                return line;
            }).join('\n');
            if (inList) html += '</ul>';

            return html.replace(/\n/g, '<br>');
        }

        function handleTabClick(e) {
            const clickedTab = e.currentTarget;
            planOutputContainer.classList.add('hidden'); // Hide main output when changing tabs
            tabs.forEach((tab, index) => {
                const isHidden = tab !== clickedTab;
                contents[index].classList.toggle('hidden', isHidden);
                tab.classList.toggle('active', !isHidden);
            });
             if(clickedTab === historyTabBtn && auth.currentUser){
                loadHistory(auth.currentUser.uid);
            }
        }

        async function handlePostPayment(userId) {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const product = urlParams.get('product');

            if (status === 'success' && product) {
                const decodedProduct = decodeURIComponent(product);
                await getUserData(userId);
                paymentStatus.textContent = `Successfully purchased ${decodedProduct}!`;
                setTimeout(() => paymentStatus.textContent = '', 5000);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (status === 'failure' || status === 'tampered' || status === 'dberror' || status === 'server_error') {
                paymentStatus.textContent = "Payment failed or could not be verified. Please try again.";
                setTimeout(() => paymentStatus.textContent = '', 5000);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // --- Event Listeners and State Management ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userStatusContainer.classList.remove('hidden');
                headerLoginBtn.classList.add('hidden');
                userStatus.textContent = `${user.phoneNumber}`;
                getUserData(user.uid).then(() => {
                    handlePostPayment(user.uid);
                });
            } else {
                userStatusContainer.classList.add('hidden');
                headerLoginBtn.classList.remove('hidden');
                usageCountInfo.textContent = `Log in to track your uses.`;
                userPurchases = {};
                document.querySelectorAll('.buy-premium-btn').forEach(button => {
                    button.classList.remove('hidden');
                });
                document.querySelectorAll('.generate-premium-plan-btn').forEach(button => {
                    button.classList.add('hidden');
                });
                updateUIForUsage();
            }
        });
        
        window.onload = () => {
            setupRecaptcha();
            resetLoginForm();
        };

        document.body.addEventListener('click', (e) => {
            const whatsappBtn = e.target.closest('.share-whatsapp-btn');
            const emailBtn = e.target.closest('.share-email-btn');
            const premiumGenBtn = e.target.closest('.generate-premium-plan-btn');
            const copyBtn = e.target.closest('.copy-plan-btn');

            if (whatsappBtn) {
                let planText = decodeURIComponent(whatsappBtn.dataset.planText);
                const shareText = `Check out this AI Plan generated for me on ${new Date().toLocaleString()}:\n\n${planText}`;
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
                window.open(whatsappUrl, '_blank');
            }

            if (emailBtn) {
                let planText = decodeURIComponent(emailBtn.dataset.planText);
                let promptText = decodeURIComponent(emailBtn.dataset.prompt);
                
                navigator.clipboard.writeText(planText).then(() => {
                    paymentStatus.textContent = "Plan copied to clipboard!";
                    setTimeout(() => paymentStatus.textContent = '', 2000);
                    
                    const subject = promptText;
                    const body = `(The full meal plan has been copied to your clipboard. Please paste it here to send.)\n\nCheck out this AI Plan generated for me on ${new Date().toLocaleString()}:\n\n`;
                    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.location.href = mailtoUrl;

                }, () => {
                     paymentStatus.textContent = "Failed to copy plan automatically.";
                    setTimeout(() => paymentStatus.textContent = '', 2000);
                });
            }
            
            if (premiumGenBtn) {
                const prompt = premiumGenBtn.dataset.productPrompt;
                if(prompt) {
                    generatePlan(prompt, true, premiumGenBtn);
                }
            }
             if (copyBtn) {
                let planText = decodeURIComponent(copyBtn.dataset.planText);
                navigator.clipboard.writeText(planText).then(() => {
                    paymentStatus.textContent = "Plan copied to clipboard!";
                    setTimeout(() => paymentStatus.textContent = '', 2000);
                }, () => {
                    paymentStatus.textContent = "Failed to copy plan.";
                    setTimeout(() => paymentStatus.textContent = '', 2000);
                });
            }
        });
        
        generatePlanBtn.addEventListener('click', (e) => {
            const familySizeInput = document.getElementById('family-size');
            if (!familySizeInput.value || parseInt(familySizeInput.value) <= 0) {
                paymentStatus.textContent = "Please enter a valid family size.";
                setTimeout(() => paymentStatus.textContent = '', 3000);
                return;
            }
            paymentStatus.textContent = ""; 
            const inputs = mealPlannerContent.querySelectorAll('input, select');
            let details = [];
            inputs.forEach(input => {
                if (input.id === 'family-size') details.push(`for a family of ${input.value} people`);
                else if (input.id === 'plan-days') details.push(`for ${input.value} days`);
                else if (input.id === 'diet-type') details.push(`with a ${input.value} diet`);
                else if (input.id === 'cuisine-type') details.push(`featuring ${input.value} cuisine`);
                else if (input.id === 'allergies' && input.value !== 'None (Allergies)') details.push(`that is safe for ${input.value}`);
                else if (input.id === 'language') details.push(`in ${input.value}`);
            });
            generatePlan(`Generate a meal plan ${details.join(', ')}`, false, e.currentTarget);
        });

        generateFestivalBtn.addEventListener('click', (e) => {
            const festival = document.getElementById('festival-select').value;
            generatePlan(`a comprehensive assistant plan for the ${festival} festival, including meals, shopping list, and activities`, false, e.currentTarget);
        });

        generateQuickBtn.addEventListener('click', (e) => {
            generatePlan('a quick and random meal plan for today', false, e.currentTarget);
        });

        document.querySelectorAll('.buy-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => handlePayment(e.target.dataset.amount, e.target.dataset.product));
        });

        closeLoginModalBtn.addEventListener('click', () => loginModalOverlay.classList.add('hidden'));
        loginModalOverlay.addEventListener('click', (e) => {
            if (e.target === loginModalOverlay) loginModalOverlay.classList.add('hidden');
        });

        tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
    </script>
</body>
</html>
