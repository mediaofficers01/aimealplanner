<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meal & Festival Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha512/0.8.0/sha512.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3e8ff; /* Fallback */
            background-image: linear-gradient(135deg, #f5f3ff 0%, #dee2ff 100%);
        }
        .plan-output {
            white-space: pre-wrap;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: left;
            min-height: 100px;
        }
        #close-login-modal {
            font-size: 2rem;
            line-height: 1;
        }
        .tab-btn.active {
            background-color: #7c3aed;
            color: white;
        }
        .tab-btn {
            background-color: #f5f3ff;
            color: #5b21b6;
        }
        .premium-card {
             background: rgba(255, 255, 255, 0.6);
             border: 1px solid rgba(255, 255, 255, 0.2);
             box-shadow: 0 8px 32px 0 rgba(124, 58, 237, 0.1);
             backdrop-filter: blur(4px);
             -webkit-backdrop-filter: blur(4px);
        }
        .generate-btn {
            background-image: linear-gradient(to right, #8b5cf6, #ec4899);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl space-y-8">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">AI Meal & Festival Planner</h1>
            <p class="text-lg text-gray-600 mt-2">Your all-in-one assistant for Indian families.</p>
        </div>

        <!-- Main Content Area -->
        <div class="bg-white/70 backdrop-blur-xl border border-gray-200 rounded-2xl shadow-lg p-6">
            <!-- Tab Navigation -->
            <div class="flex justify-center bg-purple-100/50 rounded-xl p-1.5 space-x-2">
                <button id="meal-planner-tab-btn" class="tab-btn active w-full py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 3.3a2.1 2.1 0 0 1 3 3L12 16l-4 1 1-4Z"/></svg>
                    <span>Meal Planner</span>
                </button>
                <button id="festival-assistant-tab-btn" class="tab-btn w-full py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z"/><path d="M12 20.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z"/><path d="M5.5 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M16.5 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M5.5 18.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M16.5 18.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="M3 12a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1A.5.5 0 0 1 3 12Z"/><path d="M20 12a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z"/><path d="m15.5 8.5-1 1-4-4 1-1a2.12 2.12 0 0 1 3 0l1 1a2.12 2.12 0 0 1 0 3Z"/><path d="M8.5 15.5l1-1 4 4-1 1a2.12 2.12 0 0 1-3 0l-1-1a2.12 2.12 0 0 1 0-3Z"/></svg>
                    <span>Festival Assistant</span>
                </button>
                <button id="quick-mode-tab-btn" class="tab-btn w-full py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 flex items-center justify-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.6 3.2-5.7 6c-2.3 2.4-2.3 6.1 0 8.5l5.7 6"/><path d="M5.4 3.2h.1c3.3 0 6 2.7 6 6s-2.7 6-6 6h-.1"/></svg>
                    <span>Quick Mode</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="mt-6 min-h-[220px]">
                <!-- Meal Planner Content -->
                <div id="meal-planner-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="family-size" type="number" placeholder="Family Size (e.g., 4)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <select id="diet-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option>Veg</option> <option>Non-Veg</option>
                        </select>
                        <select id="cuisine-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option>North Indian (Punjabi)</option> <option>South Indian</option> <option>Gujarati</option> <option>Bengali</option>
                        </select>
                         <select id="allergies" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option>None (Allergies)</option> <option>Nut Allergy</option> <option>Lactose Intolerance</option> <option>Gluten-Free</option>
                        </select>
                        <select id="language" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 md:col-span-2">
                            <option>English</option> <option>Hinglish</option>
                        </select>
                    </div>
                    <button id="generate-plan-btn" class="generate-btn mt-6 w-full text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300">Generate Weekly Meal Plan</button>
                </div>

                <!-- Festival Assistant Content -->
                <div id="festival-assistant-content" class="hidden">
                    <div class="text-center">
                         <h3 class="text-2xl font-bold text-gray-800 mb-4">Plan for a Festival</h3>
                         <select id="festival-select" class="w-full max-w-sm mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                             <option>Diwali</option> <option>Holi</option> <option>Eid</option> <option>Navratri</option> <option>Ganesh Chaturthi</option> <option>Pongal</option>
                         </select>
                         <button id="generate-festival-btn" class="generate-btn mt-4 w-full max-w-sm mx-auto text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300">Generate Festival Plan</button>
                    </div>
                </div>

                <!-- Quick Mode Content -->
                <div id="quick-mode-content" class="hidden text-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Get a Quick Meal Idea</h3>
                    <p class="text-gray-600 mb-4">Instantly generate a random meal plan for today.</p>
                    <button id="generate-quick-btn" class="generate-btn mt-4 w-full max-w-sm mx-auto text-white font-bold py-3.5 px-4 rounded-lg hover:opacity-90 transition-opacity duration-300">Generate Quick Plan</button>
                </div>
            </div>
             <p id="usage-count-info" class="text-xs text-center text-gray-500 mt-4">Log in to track your 4 free uses.</p>

            <!-- Output Area -->
             <div id="plan-output-container" class="mt-6 hidden">
                <h4 class="font-semibold text-lg text-gray-700 mb-2">Your AI Generated Plan:</h4>
                <div id="plan-output" class="plan-output"></div>
            </div>

            <!-- Footer / Premium Packs -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Premium One-Time Packs</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kids' Tiffin Box Planner -->
                    <div class="premium-card text-center p-6 rounded-2xl">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-pink-100 mb-4">
                            <span class="text-3xl">ðŸ˜Š</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">Kids' Tiffin Box AI Planner</h4>
                        <p class="text-gray-600 text-sm my-2">Endless, healthy, and fun ideas for your child's tiffin box.</p>
                        <button class="buy-premium-btn mt-4 w-full bg-pink-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-600 transition duration-300" data-amount="99.00" data-product="Kids Tiffin Box AI Planner">Buy Now for â‚¹99</button>
                    </div>
                    <!-- Navratri Special Diet Plan -->
                    <div class="premium-card text-center p-6 rounded-2xl">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-100 mb-4">
                            <span class="text-3xl">ðŸ”¥</span>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">Navratri Special Diet Plan</h4>
                        <p class="text-gray-600 text-sm my-2">Complete 9-day Satvik meal plan for Navratri fasting.</p>
                        <button class="buy-premium-btn mt-4 w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-300" data-amount="49.00" data-product="Navratri Special Diet Plan">Buy Now for â‚¹49</button>
                    </div>
                </div>
            </div>

            <div class="text-center pt-6">
                <p id="user-status" class="text-sm text-gray-600">Logged in as Guest</p>
                <button id="logout-btn" class="hidden text-sm text-indigo-600 font-semibold py-2 px-4">Logout</button>
            </div>
             <p id="payment-status" class="text-sm text-center text-red-500 h-4"></p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div id="login-modal" class="relative bg-white rounded-2xl shadow-lg p-8 w-full max-w-md">
            <button id="close-login-modal" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800">&times;</button>
            <div id="login-container" class="w-full">
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-gray-800">Login Required</h1>
                    <p class="text-gray-500">Please verify your phone number to continue.</p>
                </div>
                <div class="space-y-4 mt-6">
                    <div>
                        <label for="phone-number" class="text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phone-number" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="+91 XXXXX XXXXX">
                    </div>
                    <button id="send-otp-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Send OTP</button>
                    <div id="recaptcha-container"></div>
                    <div id="otp-section" class="hidden space-y-2">
                        <label for="otp" class="text-sm font-medium text-gray-700">Enter OTP</label>
                        <input type="text" id="otp" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="6-digit code">
                        <button id="verify-otp-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">Verify OTP</button>
                    </div>
                    <p id="auth-status" class="text-sm text-center text-red-500 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for PayUmoney -->
    <form id="payment-form" method="post" class="hidden"></form>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUoU9RFUJi56rYHERq8zOrl1qQBB5KQSM",
            authDomain: "mymealplannerapp-615f7.firebaseapp.com",
            projectId: "mymealplannerapp-615f7",
            storageBucket: "mymealplannerapp-615f7.firebasestorage.app",
            messagingSenderId: "653426216828",
            appId: "1:63426216828:web:a54158b674dfd72cf71ef9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Elements ---
        const otpSection = document.getElementById('otp-section');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const phoneNumberInput = document.getElementById('phone-number');
        const otpInput = document.getElementById('otp');
        const userStatus = document.getElementById('user-status');
        const authStatus = document.getElementById('auth-status');
        const paymentStatus = document.getElementById('payment-status');
        const usageCountInfo = document.getElementById('usage-count-info');
        const planOutputContainer = document.getElementById('plan-output-container');
        const planOutput = document.getElementById('plan-output');
        const loginModalOverlay = document.getElementById('login-modal-overlay');
        const closeLoginModalBtn = document.getElementById('close-login-modal');
        
        // Action Buttons
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const generateFestivalBtn = document.getElementById('generate-festival-btn');
        const generateQuickBtn = document.getElementById('generate-quick-btn');
        const allGenerateBtns = [generatePlanBtn, generateFestivalBtn, generateQuickBtn];
        
        // Tab elements
        const mealPlannerTabBtn = document.getElementById('meal-planner-tab-btn');
        const festivalAssistantTabBtn = document.getElementById('festival-assistant-tab-btn');
        const quickModeTabBtn = document.getElementById('quick-mode-tab-btn');
        const mealPlannerContent = document.getElementById('meal-planner-content');
        const festivalAssistantContent = document.getElementById('festival-assistant-content');
        const quickModeContent = document.getElementById('quick-mode-content');
        const tabs = [mealPlannerTabBtn, festivalAssistantTabBtn, quickModeTabBtn];
        const contents = [mealPlannerContent, festivalAssistantContent, quickModeContent];

        let confirmationResult = null;
        let usageCount = 0;
        const FREE_USES_LIMIT = 4;

        // --- Firestore Logic ---
        async function getUserData(userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            usageCount = userDoc.exists() ? (userDoc.data().usageCount || 0) : 0;
            if (!userDoc.exists()) {
                await setDoc(userDocRef, { usageCount: 0 });
            }
            updateUIForUsage();
        }

        async function updateUserUsageCount(userId) {
            usageCount++;
            const userDocRef = doc(db, "users", userId);
            await setDoc(userDocRef, { usageCount: usageCount }, { merge: true });
            updateUIForUsage();
        }
        
        function updateUIForUsage() {
            const usesLeft = Math.max(0, FREE_USES_LIMIT - usageCount);
            usageCountInfo.textContent = `You have ${usesLeft} free ${usesLeft === 1 ? 'use' : 'uses'} remaining.`;

            if (usesLeft <= 0) {
                allGenerateBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = "Upgrade to Continue";
                    btn.classList.remove('generate-btn');
                    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                });
            } else {
                 allGenerateBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.add('generate-btn');
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                });
                // Reset text content
                generatePlanBtn.textContent = "Generate Weekly Meal Plan";
                generateFestivalBtn.textContent = "Generate Festival Plan";
                generateQuickBtn.textContent = "Generate Quick Plan";
            }
        }
        
        // --- Authentication Logic ---
        function setupRecaptcha() {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible', 'callback': () => {} });
        }

        async function sendOtp() {
            const phoneNumber = phoneNumberInput.value;
            if (!/^\+[1-9]\d{1,14}$/.test(phoneNumber)) {
                authStatus.textContent = 'Please enter a valid phone number with country code.'; return;
            }
            authStatus.textContent = 'Sending OTP...'; sendOtpBtn.disabled = true;
            try {
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
                authStatus.textContent = 'OTP sent successfully!';
                otpSection.classList.remove('hidden'); sendOtpBtn.textContent = 'Resend OTP';
            } catch (error) {
                authStatus.textContent = `Error: ${error.message}`;
                window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
            } finally { sendOtpBtn.disabled = false; }
        }

        async function verifyOtp() {
            const code = otpInput.value;
            if (!code || code.length !== 6) { authStatus.textContent = 'Please enter a valid 6-digit OTP.'; return; }
            authStatus.textContent = 'Verifying...'; verifyOtpBtn.disabled = true;
            try {
                await confirmationResult.confirm(code);
                authStatus.textContent = 'Login successful!';
            } catch (error) {
                authStatus.textContent = `Error: Invalid OTP or session expired.`;
            } finally { verifyOtpBtn.disabled = false; }
        }
        
        // --- PayUmoney Integration ---
        function handlePayment(amount, productInfo) {
            if (!auth.currentUser) { loginModalOverlay.classList.remove('hidden'); return; }
            const payUDetails = { key: "8z5rZQDi", salt: "IsygW4nDGh", paymentUrl: "https://secure.payu.in/_payment" };
            const currentUser = auth.currentUser;
            const transactionData = {
                txnid: `AI-MEAL-${productInfo.replace(/\s+/g, '')}-${Date.now()}`,
                amount: amount, productinfo: productInfo, firstname: 'AI User', email: 'test@example.com',
                phone: currentUser.phoneNumber.substring(3),
                surl: 'https://aimealplanner-five.vercel.app/', furl: 'https://aimealplanner-five.vercel.app/',
            };
            const hashString = `${payUDetails.key}|${transactionData.txnid}|${transactionData.amount}|${transactionData.productinfo}|${transactionData.firstname}|${transactionData.email}|||||||||||${payUDetails.salt}`;
            const formData = { ...transactionData, key: payUDetails.key, hash: sha512(hashString) };
            const form = document.getElementById('payment-form');
            form.action = payUDetails.paymentUrl; form.innerHTML = '';
            for (const key in formData) {
                const input = document.createElement('input');
                input.type = 'hidden'; input.name = key; input.value = formData[key];
                form.appendChild(input);
            }
            form.submit();
        }

        // --- Main App Logic ---
        function generatePlan(prompt) {
            if (!auth.currentUser) { loginModalOverlay.classList.remove('hidden'); return; }
            if (usageCount >= FREE_USES_LIMIT) { alert("You have used all your free plans."); return; }
            
            const mockResponse = `Based on your request for "${prompt}", here is a sample plan:\n\n**Day 1:**\n- Breakfast: Poha\n- Lunch: Rajma Chawal\n- Dinner: Paneer Butter Masala with Roti.\n\n**Day 2:**\n- Breakfast: Idli Sambar\n- Lunch: Lemon Rice with Curd\n- Dinner: Aloo Gobi with Paratha.`;
            planOutput.textContent = mockResponse;
            planOutputContainer.classList.remove('hidden');
            updateUserUsageCount(auth.currentUser.uid);
        }

        function handleTabClick(e) {
            const clickedTab = e.currentTarget;
            tabs.forEach((tab, index) => {
                contents[index].classList.toggle('hidden', tab !== clickedTab);
                tab.classList.toggle('active', tab === clickedTab);
            });
        }
        
        // --- Event Listeners and State Management ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginModalOverlay.classList.add('hidden');
                userStatus.textContent = `Logged in as ${user.phoneNumber}`;
                logoutBtn.classList.remove('hidden');
                getUserData(user.uid);
            } else {
                userStatus.textContent = 'Logged in as Guest';
                logoutBtn.classList.add('hidden');
                usageCountInfo.textContent = `Log in to track your 4 free uses.`;
                updateUIForUsage(); // Will set buttons to their guest state
            }
        });
        
        window.onload = setupRecaptcha;
        sendOtpBtn.addEventListener('click', sendOtp);
        verifyOtpBtn.addEventListener('click', verifyOtp);
        logoutBtn.addEventListener('click', () => signOut(auth));
        
        generatePlanBtn.addEventListener('click', () => {
            const inputs = mealPlannerContent.querySelectorAll('input, select');
            let details = [];
            inputs.forEach(input => details.push(input.value));
            generatePlan(`a ${details.join(', ')} meal plan`);
        });

        generateFestivalBtn.addEventListener('click', () => {
            const festival = document.getElementById('festival-select').value;
            generatePlan(`a meal plan for the ${festival} festival`);
        });

        generateQuickBtn.addEventListener('click', () => {
            generatePlan('a quick and random meal plan for today');
        });

        document.querySelectorAll('.buy-premium-btn').forEach(button => {
            button.addEventListener('click', (e) => handlePayment(e.target.dataset.amount, e.target.dataset.product));
        });

        closeLoginModalBtn.addEventListener('click', () => loginModalOverlay.classList.add('hidden'));
        loginModalOverlay.addEventListener('click', (e) => {
            if (e.target === loginModalOverlay) loginModalOverlay.classList.add('hidden');
        });

        tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
    </script>
</body>
</html>

