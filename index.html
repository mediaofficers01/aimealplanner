<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meal & Festival Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://checkout.payu.in/_payment.sjs"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            background-color: #8B5CF6; /* purple-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #8B5CF6 0%, #EC4899 51%, #8B5CF6 100%);
            background-size: 200% auto;
            color: white;
            transition: 0.5s;
            box-shadow: 0 4px 15px 0 rgba(139, 92, 246, 0.4);
        }
        .btn-primary:hover {
            background-position: right center;
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #EC4899;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s
        }
        @-webkit-keyframes slideIn {
            from {bottom: -300px; opacity: 0} 
            to {bottom: 0; opacity: 1}
        }
        @keyframes slideIn {
            from {transform: translateY(20px); opacity: 0}
            to {transform: translateY(0); opacity: 1}
        }
        @-webkit-keyframes fadeIn {
            from {opacity: 0} 
            to {opacity: 1}
        }
        @keyframes fadeIn {
            from {opacity: 0} 
            to {opacity: 1}
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .prose { color: #374151; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #4c1d95; }
        .prose strong { color: #5b21b6; }
        .prose ul { list-style: disc; padding-left: 1.5rem; }
        .prose li { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen w-full p-4 flex items-center justify-center">
        <div class="w-full max-w-4xl mx-auto">
            
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-white text-shadow">AI Meal & Festival Planner</h1>
                <p class="text-white/80 mt-1">Your all-in-one assistant for Indian families.</p>
            </header>
            
            <div class="glass-card rounded-2xl shadow-2xl p-4 sm:p-6">

                <!-- Tabs -->
                <div id="tabs-container" class="mb-6 bg-purple-100/50 rounded-lg p-1.5 flex justify-center space-x-2">
                    <button class="flex-1 flex items-center justify-center gap-2 text-sm sm:text-base font-semibold py-2.5 px-4 rounded-md" data-tab="meal-planner">
                        <i data-lucide="utensils-crossed"></i> Meal Planner
                    </button>
                    <button class="flex-1 flex items-center justify-center gap-2 text-sm sm:text-base font-semibold text-purple-600 py-2.5 px-4 rounded-md" data-tab="festival-assistant">
                        <i data-lucide="party-popper"></i> Festival Assistant
                    </button>
                    <button class="flex-1 flex items-center justify-center gap-2 text-sm sm:text-base font-semibold text-purple-600 py-2.5 px-4 rounded-md" data-tab="quick-mode">
                        <i data-lucide="zap"></i> Quick Mode
                    </button>
                </div>

                <!-- Tab Content -->
                <main id="tab-content">
                    <!-- AI Daily Meal Planner -->
                    <div id="meal-planner-content" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="number" id="family-size" class="w-full p-2 border border-purple-200 rounded-lg" placeholder="Family Size (e.g., 4)">
                            <select id="diet-type" class="w-full p-2 border border-purple-200 rounded-lg">
                                <option>Veg</option><option>Non-Veg</option><option>Jain</option><option>Satvik</option>
                            </select>
                            <select id="regional-taste" class="w-full p-2 border border-purple-200 rounded-lg">
                                <option>North Indian (Punjabi)</option><option>Gujarati</option><option>South Indian</option><option>Bengali</option><option>Marathi</option>
                            </select>
                            <select id="health-pref" class="w-full p-2 border border-purple-200 rounded-lg">
                                <option>None</option><option>Low Oil</option><option>Diabetic-Friendly</option><option>Kids-Friendly</option>
                            </select>
                            <select id="language" class="w-full p-2 border border-purple-200 rounded-lg">
                                <option>English</option><option>Hindi</option><option>Hinglish</option>
                            </select>
                        </div>
                        <button id="generate-meal-plan" class="w-full btn-primary font-semibold py-3 px-4 rounded-lg">Generate Weekly Meal Plan</button>
                    </div>

                    <!-- AI Festival Assistant -->
                    <div id="festival-assistant-content" class="hidden flex flex-col items-center space-y-6">
                        <select id="festival-name" class="w-full max-w-sm p-2 border border-purple-200 rounded-lg">
                            <option>Diwali</option><option>Holi</option><option>Raksha Bandhan</option><option>Navratri</option><option>Karva Chauth</option><option>Janmashtami</option>
                        </select>
                        <button id="generate-festival-plan" class="w-full max-w-sm btn-primary font-semibold py-3 px-4 rounded-lg">Get Festival Guide</button>
                    </div>

                    <!-- Quick Mode -->
                    <div id="quick-mode-content" class="hidden flex flex-col items-center space-y-4">
                        <button id="quick-cook" class="w-full max-w-sm btn-primary font-semibold py-3 px-4 rounded-lg">What to cook today?</button>
                        <button id="guest-menu" class="w-full max-w-sm btn-primary font-semibold py-3 px-4 rounded-lg">Guests coming tonight?</button>
                    </div>
                </main>
            </div>

            <!-- Output & Status Area -->
            <div class="mt-6 text-center">
                <div id="auth-status" class="mb-4">
                    <p class="text-sm font-semibold text-white/80">Connecting...</p>
                </div>
                 <div id="usage-tracker" class="p-2 bg-white/30 rounded-lg inline-block hidden">
                    <p class="text-sm text-purple-900">
                        Plans used: <span id="usage-count" class="font-bold">0</span>/3.
                        <button id="upgrade-button" class="ml-2 font-semibold text-purple-700 hover:underline">Upgrade</button>
                    </p>
                </div>
            </div>

            <div id="output-area" class="mt-6 glass-card rounded-2xl shadow-xl p-6 hidden">
                <div id="loader" class="loader mx-auto hidden"></div>
                <div id="result-content"></div>
            </div>

            <!-- Premium Packs Section -->
            <div id="premium-packs" class="mt-8">
                <h2 class="text-center text-2xl font-bold text-white mb-4">Premium One-Time Packs</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kids' Tiffin Box Planner -->
                    <div class="glass-card rounded-2xl p-6 flex flex-col items-center text-center">
                        <div class="p-3 bg-pink-200 rounded-full mb-3">
                            <i data-lucide="smile" class="text-pink-600"></i>
                        </div>
                        <h3 class="font-bold text-lg text-purple-800">Kids' Tiffin Box AI Planner</h3>
                        <p class="text-purple-700/80 text-sm mt-1 mb-3">Endless, healthy, and fun ideas for your child's tiffin box.</p>
                        <p class="text-2xl font-bold text-purple-900 mb-4">₹99</p>
                        <button id="buy-tiffin-pack" class="w-full btn-primary font-semibold py-2 px-4 rounded-lg">Buy Now</button>
                    </div>
                    <!-- Navratri Special Diet Plan -->
                    <div class="glass-card rounded-2xl p-6 flex flex-col items-center text-center">
                         <div class="p-3 bg-orange-200 rounded-full mb-3">
                            <i data-lucide="flame" class="text-orange-600"></i>
                        </div>
                        <h3 class="font-bold text-lg text-purple-800">Navratri Special Diet Plan</h3>
                        <p class="text-purple-700/80 text-sm mt-1 mb-3">Complete 9-day Satvik meal plan for Navratri fasting.</p>
                        <p class="text-2xl font-bold text-purple-900 mb-4">₹49</p>
                        <button id="buy-navratri-pack" class="w-full btn-primary font-semibold py-2 px-4 rounded-lg">Buy Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="modal-close">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Unlock Unlimited Planning!</h2>
            <p class="text-gray-600 mb-6">You've reached your free limit. Upgrade now for unlimited meal plans, festival guides, and exclusive features.</p>
            <div class="bg-gray-100 p-4 rounded-lg mb-6 text-center">
                <p class="text-3xl font-bold text-purple-600">₹99 <span class="text-lg font-normal text-gray-500">/ month</span></p>
            </div>
            <button id="subscribe-now" class="w-full btn-primary font-bold py-3 px-4 rounded-lg shadow-lg text-lg">Subscribe Now</button>
        </div>
    </div>

    <script type="module">
        lucide.createIcons();

        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUoU9RFUJi56rYHERq8zOrl1qQBB5KQSM",
            authDomain: "mymealplannerapp-615f7.firebaseapp.com",
            projectId: "mymealplannerapp-615f7",
            storageBucket: "mymealplannerapp-615f7.firebasestorage.app",
            messagingSenderId: "653426216828",
            appId: "1:653426216828:web:a54158b674dfd72cf71ef9",
            measurementId: "G-07NH5QZWYJ"
        };
        
        // --- Gemini AI Configuration ---
        const GEMINI_API_KEY = "AIzaSyDsjORy0X4SZEaQBYbkwq0_cbA2-_qC1v0";

        // --- PayU Configuration ---
        const functionUrl = "https://payuhashgenerator-ejvt7xfcha-uc.a.run.app"; 
        const payuConfig = {
            furl: window.location.href, // Failure URL
            surl: window.location.href, // Success URL
        };

        // --- Application State ---
        let db, auth, userId = null, userDocRef = null, usageCount = 0;
        const FREE_LIMIT = 3;

        // --- Firebase Initialization ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('auth-status').innerHTML = `<p class="text-sm font-semibold text-red-300">❌ Offline: Could not connect to backend.</p>`;
        }

        // --- Authentication Handling ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-status').innerHTML = `<p class="text-sm font-semibold text-white/90">✅ Online</p>`;
                userDocRef = doc(db, "users", userId);
                setupUsageListener();
            } else {
                signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
            }
        });
        
        // --- Database Listener ---
        function setupUsageListener() {
            onSnapshot(userDocRef, docSnap => {
                const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
                if (docSnap.exists() && docSnap.data().month === currentMonth) {
                    usageCount = docSnap.data().usageCount || 0;
                } else {
                    usageCount = 0;
                    if (!docSnap.exists()) console.log("Creating user profile.");
                    updateUsageCount(0);
                }
                updateUsageUI();
            });
        }
        
        async function updateUsageCount(newCount) {
            if (!userDocRef) return;
            const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            await setDoc(userDocRef, { usageCount: newCount, month: currentMonth }, { merge: true });
        }

        function updateUsageUI() {
             document.getElementById('usage-count').textContent = usageCount;
             document.getElementById('usage-tracker').classList.remove('hidden');
        }

        // --- UI Logic (Tabs, Modals) ---
        const tabsContainer = document.getElementById('tabs-container');
        const mainContentContainer = document.getElementById('tab-content');
        const upgradeModal = document.getElementById('upgradeModal');
        const closeModal = document.getElementById('closeModal');
        const upgradeButton = document.getElementById('upgrade-button');

        function switchTab(activeTabId) {
            tabsContainer.querySelectorAll('button').forEach(button => {
                const isButtonActive = button.dataset.tab === activeTabId;
                button.classList.toggle('tab-active', isButtonActive);
                button.classList.toggle('text-white', isButtonActive);
                button.classList.toggle('text-purple-600', !isButtonActive);
            });
            mainContentContainer.querySelectorAll(':scope > div').forEach(contentPanel => {
                const isPanelActive = contentPanel.id === `${activeTabId}-content`;
                // Use inline styles for more reliable show/hide with flexbox
                contentPanel.style.display = isPanelActive ? '' : 'none';
            });
        }

        function initializeTabs() {
            tabsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (event) => {
                    switchTab(event.currentTarget.dataset.tab);
                });
            });
            switchTab('meal-planner'); // Set initial state
        }
        
        initializeTabs();

        upgradeButton.onclick = () => upgradeModal.style.display = "block";
        closeModal.onclick = () => upgradeModal.style.display = "none";
        window.onclick = e => { if (e.target == upgradeModal) upgradeModal.style.display = "none"; }

        // --- Core Application Logic ---
        document.getElementById('generate-meal-plan').addEventListener('click', () => handleGeneration('meal'));
        document.getElementById('generate-festival-plan').addEventListener('click', () => handleGeneration('festival'));
        document.getElementById('quick-cook').addEventListener('click', () => handleGeneration('quick-cook'));
        document.getElementById('guest-menu').addEventListener('click', () => handleGeneration('guest-menu'));

        function handleGeneration(type) {
            if (usageCount >= FREE_LIMIT) {
                upgradeModal.style.display = 'block';
                return;
            }
            const prompt = createPrompt(type);
            callAI(prompt);
            updateUsageCount(usageCount + 1);
        }
        
        function createPrompt(type) {
            document.getElementById('output-area').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('result-content').innerHTML = '';
            
            switch(type) {
                case 'meal': return `Generate a 7-day weekly meal plan for a family of ${document.getElementById('family-size').value}. Preferences: ${document.getElementById('diet-type').value}, ${document.getElementById('regional-taste').value} taste, ${document.getElementById('health-pref').value}. The response should be in ${document.getElementById('language').value}. Format it nicely with sections for Breakfast, Lunch, and Dinner each day. Include a consolidated grocery list at the end. Use markdown for formatting.`;
                case 'festival': return `Create a comprehensive guide for the ${document.getElementById('festival-name').value} festival. Include: 1. A detailed Pooja Samagri checklist. 2. Creative decoration ideas. 3. Recipes for 3-4 traditional foods. 4. Three WhatsApp greeting templates (text only). Format the entire response clearly with headings using markdown.`;
                case 'quick-cook': return `I need to cook today but I'm in a hurry. Suggest 5 different quick meal ideas that take under 30 minutes to prepare. Provide a one-line description for each. Use markdown for formatting.`;
                case 'guest-menu': return `I have guests coming for dinner tonight. Suggest a full, impressive North Indian (Punjabi) vegetarian menu. Include 1 starter, 2 main course dishes, 1 dal, 1 raita, and 1 dessert. Also provide a consolidated grocery list for this menu. Use markdown for formatting.`;
            }
        }

        async function callAI(prompt) {
            console.log("Calling Gemini AI with prompt:", prompt);
            const loader = document.getElementById('loader');
            const resultDiv = document.getElementById('result-content');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiText) {
                    const formattedHtml = aiText
                        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-purple-800 mt-4 mb-2">$1</h2>')
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-purple-700 mt-3 mb-1">$1</h3>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/^\* (.*$)/gim, '<li>$1</li>')
                        .replace(/(\n<li>.*<\/li>)+/g, '<ul>$&</ul>')
                        .replace(/\n/g, '<br>');
                    resultDiv.innerHTML = `<div class="prose max-w-none">${formattedHtml}</div>`;
                } else {
                    resultDiv.innerHTML = `<p class="text-red-500 font-semibold">Sorry, the AI could not generate a response. Please try again.</p>`;
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">An error occurred while contacting the AI. Your API key might be invalid or have restrictions. Please check the console for details.</p>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- Reusable PayU Payment Logic ---
        async function initiatePayment(details, buttonElement) {
            if (!userId) { 
                alert("Please wait, user profile is not ready yet."); 
                return; 
            }
            
            const paymentDetails = {
                ...details,
                firstname: "Guest",
                email: "guest@example.com",
                txnid: "TXN" + Date.now()
            };

            const originalButtonText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = "Processing...";

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentDetails),
                });

                // **IMPROVED ERROR HANDLING**
                // This will show us the specific error from the server.
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}: ${errorText}`);
                }

                const { hash, key } = await response.json();

                const paymentData = { ...paymentDetails, key, hash, ...payuConfig, phone: '9999999999' };
                payu.launch(paymentData);
                
                // Reset button after a delay in case the user closes the payment window
                setTimeout(() => {
                    buttonElement.disabled = false;
                    buttonElement.textContent = originalButtonText;
                }, 3000);

            } catch (error) {
                console.error("Payment initiation failed:", error);
                // The alert will now be much more informative.
                alert(`Could not start payment.\n\nDetails: ${error.message}`);
                buttonElement.disabled = false;
                buttonElement.textContent = originalButtonText;
            }
        }
        
        // --- Event Listeners for all Payment Buttons ---
        document.getElementById('subscribe-now').addEventListener('click', (e) => {
            initiatePayment({
                amount: "99.00",
                productinfo: "AI Meal Planner Premium (Monthly)"
            }, e.target);
        });

        document.getElementById('buy-tiffin-pack').addEventListener('click', (e) => {
            initiatePayment({
                amount: "99.00",
                productinfo: "Kids' Tiffin Box AI Planner Pack"
            }, e.target);
        });

        document.getElementById('buy-navratri-pack').addEventListener('click', (e) => {
            initiatePayment({
                amount: "49.00",
                productinfo: "Navratri Special Diet Plan Pack"
            }, e.target);
        });
    </script>
</body>
</html>
